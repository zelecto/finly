{% extends "base.html" %}

{% block title %}Anualidades{% endblock %}

{% block content %}
<div class="container">
    <div class="header-small">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="FINLY Logo" class="logo-small">
        <h1>üìÖ Anualidades</h1>
        <span class="user-info">{{ username }}</span>
    </div>
    
<!-- Secci√≥n de Teor√≠a Colapsable -->
    <div class="teoria-section">
        <button class="teoria-toggle" type="button" id="teoriaBtn">
            <span id="teoriaIcon">‚ñ∂</span> Teor√≠a: ¬øQu√© son las Anualidades?
        </button>
        <div class="teoria-content" id="teoriaContent">
            <h3>üí° Conceptos B√°sicos</h3>
            <p><strong>Una anualidad</strong> es una serie de pagos o cobros iguales realizados a intervalos regulares de tiempo.</p>
            
            <h4>Tipos de Anualidades:</h4>
            <div class="tipo-box">
                <strong>üîπ Anualidad Ordinaria (Vencida):</strong> Los pagos se realizan al <strong>final</strong> de cada per√≠odo.<br>
                <strong>üîπ Anualidad Anticipada:</strong> Los pagos se realizan al <strong>inicio</strong> de cada per√≠odo.
            </div>

            <h4>F√≥rmulas Principales:</h4>
            <div class="formula-box">
                <strong>Valor Futuro (VF):</strong><br>
                VF = A √ó [(1 + i)‚Åø - 1] / i<br><br>
                <strong>Valor Presente (VP):</strong><br>
                VP = A √ó [1 - (1 + i)‚Åª‚Åø] / i<br><br>
            
            </div>

            <h4>Variables:</h4>
            <ul>
                <li><strong>A (Renta):</strong> Pago peri√≥dico constante</li>
                <li><strong>VP (Valor Presente):</strong> Valor actual de la anualidad</li>
                <li><strong>VF (Valor Futuro):</strong> Valor acumulado al final</li>
                <li><strong>i (Tasa):</strong> Tasa de inter√©s por per√≠odo</li>
                <li><strong>n (Per√≠odos):</strong> N√∫mero de pagos</li>
            </ul>


        </div>
    </div>

    <p>Completa exactamente <strong>4 campos</strong> y deja <strong>1 vac√≠o</strong>. El c√°lculo se realizar√° en el servidor.</p>

    <form id="anualidadesForm">
        <div class="input-row">
            <div class="input-group">
                <label for="renta">Renta (R):</label>
                <input type="number" id="renta" name="renta">
            </div>

            <div class="input-group">
                <label for="n">N√∫mero de per√≠odos (n):</label>
                <input type="number" id="n" name="n">
            </div>
        </div>

        <div class="input-row">
            <div class="input-group">
                <label for="tasa">Tasa de inter√©s (i):</label>
                <input type="number" id="tasa" name="tasa" step="0.01">
                <small> </small>
            </div>
        <div class="input-group full-width">
                <label for="calcular">¬øQu√© deseas calcular?</label>
                <select id="calcular" name="calcular">
                    <option value="vf">Valor Futuro (VF)</option>
                    <option value="va">Valor Presente (VA)</option>
                </select>
            </div>
           
        </div>

        <button type="submit" class="btn" id="calcularBtn"> Calcular</button>
    </form>

   <div class="result-box hidden" id="resultBox">
        <div class="result-content">
            <h3>üí∞ Resultado:</h3>
            <div class="result-value" id="resultValue">0</div>
            <div class="result-detail" id="resultDetail"></div>
        </div>
    </div>
</div>
<script>
    // Funci√≥n para toggle de teor√≠a
    document.getElementById('teoriaBtn').addEventListener('click', function() {
        const content = document.getElementById('teoriaContent');
        const icon = document.getElementById('teoriaIcon');
        
        content.classList.toggle('show');
        icon.classList.toggle('rotated');
    });
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('anualidadesForm');
        const resultBox = document.getElementById('resultBox');
        const resultValue = document.getElementById('resultValue');
        const resultDetail = document.getElementById('resultDetail');

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Obtener valores del formulario
            const renta = parseFloat(document.getElementById('renta').value);
            const n = parseFloat(document.getElementById('n').value);
            const tasa = parseFloat(document.getElementById('tasa').value);
            const calcular = document.getElementById('calcular').value;
            
            // Validar que todos los campos requeridos est√©n llenos
            if (isNaN(renta) || isNaN(n) || isNaN(tasa)) {
                alert('Por favor, completa todos los campos requeridos (Renta, Per√≠odos y Tasa)');
                return;
            }

            // Preparar datos seg√∫n lo que se quiere calcular
            let data = {
                A: renta,
                n: n,
                i: tasa
            };

            // Configurar qu√© campo dejar en 0 seg√∫n la selecci√≥n
            if (calcular === 'vf') {
                data.vf = 0;
                data.va = null;
            } else if (calcular === 'va') {
                data.va = 0;
                data.vf = null;
            }

            try {
                // Mostrar loading
                document.getElementById('calcularBtn').textContent = 'Calculando...';
                document.getElementById('calcularBtn').disabled = true;

                // Hacer petici√≥n al backend
                const response = await fetch('http://127.0.0.1:5000/calcular_Anualidad', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Error en el c√°lculo');
                }

                const result = await response.json();
                
                // Mostrar resultado
                let calculatedValue;
                let resultText;
                
                if (result.vf !== undefined) {
                    calculatedValue = result.vf;
                    resultText = 'Valor Futuro';
                } else if (result.va !== undefined) {
                    calculatedValue = result.va;
                    resultText = 'Valor Presente';
                }

                resultValue.textContent = `$${calculatedValue.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                resultDetail.textContent = `${resultText} calculado con los par√°metros ingresados`;
                
                // Mostrar caja de resultado
                resultBox.classList.remove('hidden');
                
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                // Restaurar bot√≥n
                document.getElementById('calcularBtn').textContent = 'Calcular';
                document.getElementById('calcularBtn').disabled = false;
            }
        });
    });
</script>

{% endblock %}